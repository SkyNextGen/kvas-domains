name: build-kvas-list

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run builder + report
        run: |
          python src/build.py
          python src/report.py

      - name: Commit dist
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dist/
          git diff --cached --quiet || git commit -m "Update domain lists"
          git push

      - name: Notify Telegram (report)
        if: always()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python - <<'PY'
          import os
          import pathlib
          import requests

          token = os.environ.get("TG_BOT_TOKEN")
          chat_id = os.environ.get("TG_CHAT_ID")

          if not token or not chat_id:
              raise SystemExit("TG_BOT_TOKEN/TG_CHAT_ID not set")

          msg_path = pathlib.Path("dist/tg_message.txt")
          if not msg_path.exists():
              raise SystemExit("dist/tg_message.txt missing")

          text = msg_path.read_text(encoding="utf-8").strip()
          if not text:
              raise SystemExit("dist/tg_message.txt empty")

          url = f"https://api.telegram.org/bot{token}/sendMessage"
          r = requests.post(url, data={
              "chat_id": chat_id,
              "text": text,
              "disable_web_page_preview": "true"
          }, timeout=30)
          if r.status_code >= 300:
              raise SystemExit(f"Telegram sendMessage failed: {r.status_code} {r.text[:200]}")
          PY

      - name: Notify Telegram (alerts)
        if: always()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python - <<'PY'
          import os
          import pathlib
          import requests

          token = os.environ.get("TG_BOT_TOKEN")
          chat_id = os.environ.get("TG_CHAT_ID")

          if not token or not chat_id:
              raise SystemExit(0)

          alert_path = pathlib.Path("dist/tg_alert.txt")
          if not alert_path.exists():
              raise SystemExit(0)

          text = alert_path.read_text(encoding="utf-8").strip()
          if not text:
              raise SystemExit(0)

          url = f"https://api.telegram.org/bot{token}/sendMessage"
          r = requests.post(url, data={
              "chat_id": chat_id,
              "text": text,
              "disable_web_page_preview": "true"
          }, timeout=30)
          if r.status_code >= 300:
              raise SystemExit(f"Telegram alerts failed: {r.status_code} {r.text[:200]}")
          PY

      - name: Notify Telegram (failure)
        if: failure()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python - <<'PY'
          import os
          import requests

          token = os.environ.get("TG_BOT_TOKEN")
          chat_id = os.environ.get("TG_CHAT_ID")

          if not token or not chat_id:
              raise SystemExit(0)

          url = f"https://api.telegram.org/bot{token}/sendMessage"
          text = "ðŸ“¦ BUILD SYSTEM\nðŸ”´ GitHub Actions\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸš¨ CRITICAL\n\nâŒ Workflow ÑƒÐ¿Ð°Ð» Ð´Ð¾ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°.\n\nðŸ”— Actions: https://github.com/${{ github.repository }}/actions"
          requests.post(url, data={"chat_id": chat_id, "text": text, "disable_web_page_preview": "true"}, timeout=30)
          PY
