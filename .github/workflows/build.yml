
name: build-kvas-list

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run builder + report
        run: |
          python src/build.py
          python src/report.py

      - name: Notify Telegram (unified format)
        if: success()
        run: |
          DATE=$(date '+%d.%m.%Y')
          TIME=$(date '+%H:%M:%S ĞœĞ¡Ğš')

          TEXT="ğŸ§© KVAS â€¢ GitHub Actions
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŸ¢ ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢: ĞĞ˜Ğ—ĞšĞ˜Ğ™
ğŸš€ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°
ğŸŸ¢ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ°

ğŸ—“ ${DATE}
ğŸ•’ ${TIME}

ğŸ“Š $(jq -r '.final_total') / $(jq -r '.limit') ($(jq -r '.limit_percent')%)

ğŸ“ˆ Ğ¢Ğ Ğ•ĞĞ”
Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ (7): $(jq -r '.trend_avg')
Î” Ğº Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ¹: $(jq -r '.trend_delta')

ğŸ” sha256: $(jq -r '.sha256_short')

ğŸ”— ĞÑ‚Ñ‡Ñ‘Ñ‚:
https://github.com/${{ github.repository }}/blob/main/dist/report.md"

          curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage             -d chat_id=${{ secrets.TG_CHAT_ID }}             -d text="$TEXT"

      - name: Notify Telegram (failure)
        if: failure()
        run: |
          DATE=$(date '+%d.%m.%Y')
          TIME=$(date '+%H:%M:%S ĞœĞ¡Ğš')

          TEXT="ğŸ§© KVAS â€¢ GitHub Actions
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”´ ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢: Ğ’Ğ«Ğ¡ĞĞšĞ˜Ğ™
ğŸš¨ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ğ¼Ğ¸

ğŸ—“ ${DATE}
ğŸ•’ ${TIME}

âš  ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Actions:
https://github.com/${{ github.repository }}/actions"

          curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage             -d chat_id=${{ secrets.TG_CHAT_ID }}             -d text="$TEXT"
