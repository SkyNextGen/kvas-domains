name: build-kvas-list

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

# IMPORTANT:
# To allow "git push" from Actions, repo settings must allow write access for GITHUB_TOKEN:
# Settings â†’ Actions â†’ General â†’ Workflow permissions â†’ Read and write permissions
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run builder + report
        run: |
          python src/build.py
          python src/report.py

      - name: Commit dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dist/
          git diff --cached --quiet || git commit -m "Update domain lists"
          # Ensure authenticated remote (works with GITHUB_TOKEN when write permissions are enabled)
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git push

      - name: Notify Telegram (report)
        if: always()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          if [ -z "${TG_BOT_TOKEN}" ] || [ -z "${TG_CHAT_ID}" ]; then
            echo "TG_BOT_TOKEN/TG_CHAT_ID not set; skip"
            exit 0
          fi
          if [ ! -s "dist/tg_message.txt" ]; then
            echo "dist/tg_message.txt missing/empty; skip"
            exit 0
          fi

          TEXT="$(cat dist/tg_message.txt)"

          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage"             -d "chat_id=${TG_CHAT_ID}"             --data-urlencode "text=${TEXT}"             -d "disable_web_page_preview=true" >/dev/null

      - name: Notify Telegram (alerts)
        if: always()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          if [ -z "${TG_BOT_TOKEN}" ] || [ -z "${TG_CHAT_ID}" ]; then
            exit 0
          fi
          if [ ! -s "dist/tg_alert.txt" ]; then
            exit 0
          fi

          TEXT="$(cat dist/tg_alert.txt)"

          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage"             -d "chat_id=${TG_CHAT_ID}"             --data-urlencode "text=${TEXT}"             -d "disable_web_page_preview=true" >/dev/null

      - name: Notify Telegram (failure)
        if: failure()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          if [ -z "${TG_BOT_TOKEN}" ] || [ -z "${TG_CHAT_ID}" ]; then
            exit 0
          fi

          TEXT="ðŸ“¦ BUILD SYSTEM
ðŸ”´ GitHub Actions
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸš¨ CRITICAL

âŒ Workflow ÑƒÐ¿Ð°Ð» Ð´Ð¾ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°.

ðŸ”— Actions:
https://github.com/${GITHUB_REPOSITORY}/actions"

          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage"             -d "chat_id=${TG_CHAT_ID}"             --data-urlencode "text=${TEXT}"             -d "disable_web_page_preview=true" >/dev/null
