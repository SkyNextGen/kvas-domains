name: build-kvas-list

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run builder + report
        run: |
          python src/build.py
          python src/report.py

      - name: Commit dist
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dist/
          git diff --cached --quiet || git commit -m "Update domain lists"
          git push

      - name: Notify Telegram (report)
        if: always()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python - << 'PY'
          import os, pathlib, requests
          token = os.environ["TG_BOT_TOKEN"]
          chat_id = os.environ["TG_CHAT_ID"]

          caption_path = pathlib.Path("dist/tg_message.txt")
          report_path = pathlib.Path("dist/report.md")

          if not caption_path.exists() or not report_path.exists():
              raise SystemExit("Telegram files missing")

          caption = caption_path.read_text(encoding="utf-8")

          url = f"https://api.telegram.org/bot{token}/sendDocument"
          with report_path.open("rb") as f:
              requests.post(url, data={
                  "chat_id": chat_id,
                  "caption": caption,
                  "disable_web_page_preview": "true"
              }, files={"document": f})
          PY

      - name: Notify Telegram (alerts)
        if: always()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python - << 'PY'
          import os, pathlib, requests
          token = os.environ["TG_BOT_TOKEN"]
          chat_id = os.environ["TG_CHAT_ID"]

          alert_path = pathlib.Path("dist/tg_alert.txt")
          if not alert_path.exists():
              raise SystemExit(0)

          text = alert_path.read_text(encoding="utf-8").strip()
          if not text:
              raise SystemExit(0)

          url = f"https://api.telegram.org/bot{token}/sendMessage"
          requests.post(url, data={
              "chat_id": chat_id,
              "text": text,
              "disable_web_page_preview": "true"
          })
          PY

      - name: Notify Telegram (failure)
        if: failure()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python - << 'PY'
          import os, requests
          token = os.environ["TG_BOT_TOKEN"]
          chat_id = os.environ["TG_CHAT_ID"]

          url = f"https://api.telegram.org/bot{token}/sendMessage"
          text = "ðŸš¨ Workflow ÑƒÐ¿Ð°Ð» Ð´Ð¾ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ GitHub Actions."
          requests.post(url, data={
              "chat_id": chat_id,
              "text": text
          })
          PY
