name: build-kvas-list

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run builder + report
        run: |
          python src/build.py
          python src/report.py

      - name: Commit dist
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dist/
          git diff --cached --quiet || git commit -m "Update domain lists"
          git push

      # âœ… Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ (Ð±ÐµÐ· Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð° report.md)
      - name: Notify Telegram (report)
        if: always()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          if [ -z "${TG_BOT_TOKEN}" ] || [ -z "${TG_CHAT_ID}" ]; then
            echo "TG_BOT_TOKEN/TG_CHAT_ID not set; skip"
            exit 0
          fi

          if [ ! -s "dist/tg_message.txt" ]; then
            echo "dist/tg_message.txt missing/empty; skip"
            exit 0
          fi

          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage"             -d "chat_id=${TG_CHAT_ID}"             --data-urlencode "text@dist/tg_message.txt"             -d "disable_web_page_preview=true" >/dev/null

      # (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾) Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð°Ð»ÐµÑ€Ñ‚-ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ, ÐµÑÐ»Ð¸ dist/tg_alert.txt ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð¸ Ð½Ðµ Ð¿ÑƒÑÑ‚Ð¾Ð¹
      - name: Notify Telegram (alerts)
        if: always()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          if [ -z "${TG_BOT_TOKEN}" ] || [ -z "${TG_CHAT_ID}" ]; then
            exit 0
          fi

          if [ ! -s "dist/tg_alert.txt" ]; then
            exit 0
          fi

          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage"             -d "chat_id=${TG_CHAT_ID}"             --data-urlencode "text@dist/tg_alert.txt"             -d "disable_web_page_preview=true" >/dev/null

      - name: Notify Telegram (failure)
        if: failure()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          if [ -z "${TG_BOT_TOKEN}" ] || [ -z "${TG_CHAT_ID}" ]; then
            exit 0
          fi

          TEXT="ðŸ“¦ BUILD SYSTEM
ðŸ”´ GitHub Actions
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ”´ ÐŸÐ Ð˜ÐžÐ Ð˜Ð¢Ð•Ð¢: Ð’Ð«Ð¡ÐžÐšÐ˜Ð™
ðŸš¨ Workflow ÑƒÐ¿Ð°Ð» Ð´Ð¾ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ð°.

ðŸ”— Actions:
https://github.com/${GITHUB_REPOSITORY}/actions"

          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage"             -d "chat_id=${TG_CHAT_ID}"             --data-urlencode "text=${TEXT}"             -d "disable_web_page_preview=true" >/dev/null
